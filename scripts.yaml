setup:
  - dart pub get --precompile

build_runner:
  (aliases): br
  build:
    (aliases): b
    (command): dart pub run build_runner build --delete-conflicting-outputs

  watch:
    (aliases): w
    (command): dart pub run build_runner watch --delete-conflicting-outputs

_packages:
  - autoequal
  - autoequal_gen

format: cd {$_packages} && dart format .
analyze: cd {$_packages} && dart analyze .

test:
  gen: cd autoequal_gen && sip test
  e2e: cd e2e_project && sip test

publish:
  (bail):
  (command):
    - "{$test:gen} --bail"
    - "{$test:e2e} --bail"
    - "{$format}"
    - "{$analyze}"
    - "{$publish:pubspec}"
    - dart pub publish
    - "{$publish:commit}"
    - "{$publish:tag}"
    - "{$publish:_push}"
  _version: |
    # get version from changelog
    version=$(grep -m 1 "# " CHANGELOG.md | awk '{print $2}')

  commit: |
    "{$publish:_version}"

    echo "Committing version $version"
    git add .
    git commit -m "v$version"

  pubspec: |
    "{$publish:_version}"

    sed -i '' "s/version: .*/version: $version/" pubspec.yaml

  tag: |
    "{$publish:_version}"

    echo "Tagging version $version"
    git tag -a "v$version" -m "v$version"

  _push: |
    echo "Pushing to origin"
    git push
    git push --tags
